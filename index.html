<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Translate Blitz: A fun English-to-Spanish translation game with customizable word lists.">
  <title>Translate Blitz</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.2/p5.min.js"></script>
  <style>
    body {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
      background-color: #e6f3ff;
      font-family: Arial, sans-serif;
      margin: 0;
    }
    canvas {
      border: 3px solid #005580;
      border-radius: 10px;
    }
    #inputTranslation, #fileInput, #typeSelect {
      margin: 10px;
      padding: 12px;
      font-size: 18px;
      width: 300px;
      border: 2px solid #005580;
      border-radius: 5px;
      background-color: rgba(255, 255, 255, 0.9);
    }
    #submitButton, #startButton {
      margin: 2px;
      padding: 10px 20px;
      font-size: 16px;
      background-color: #0077b3;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
    }
    #submitButton:hover, #startButton:hover {
      background-color: #005580;
    }
    #errorTable {
      border-collapse: collapse;
      width: 80%;
      margin-top: 20px;
      font-size: 16px;
      background-color: rgba(255, 255, 255, 0.9);
    }
    #errorTable th, #errorTable td {
      border: 1px solid #005580;
      padding: 8px;
      text-align: left;
    }
    #errorTable th {
      background-color: #0077b3;
      color: white;
    }
    #errorTable tr:nth-child(even) {
      background-color: #f2f2f2;
    }
    #errorTable tr:hover {
      background-color: #e6f3ff;
    }
  </style>
</head>
<body>
  <input type="file" id="fileInput" accept=".txt">
  <select id="typeSelect">
    <option value="easy">Easy (15s)</option>
    <option value="medium">Medium (8s)</option>
    <option value="hard">Hard (3s)</option>
  </select>
  <button id="startButton" onclick="startPlaying()" style="display: none;">Start Game</button>
  <input type="text" id="inputTranslation" placeholder="Type your translation here" style="display: none;">
  <button id="submitButton" onclick="submit()" style="display: none;">Confirm</button>
  <script>
    let phrases = [];
    let currentPhrase = null;
    let score = 0;
    let correctAnswers = 0;
    let incorrectTranslations = 0;
    let timeLeft = 3;
    let gameState = 'waiting';
    let round = 0;
    let maxRounds = 20;
    let errors = [];
    let practiceRound = 0;
    let maxPracticeRounds = 3;
    let currentPhraseIndex = 0;
    let fileLoaded = false;
    let difficultyTimes = { easy: 15, medium: 8, hard: 3 };
    let translations = {};
    let particles = [];
    let color1, color2;
    let countdownTimer = 0;
    let countdownNumber = 3;

    const fallbackTranslations = {
      'hello': ['hola'],
      'hi': ['hola'],
      'goodbye': ['adiós', 'hasta luego'],
      'please': ['por favor'],
      'thank you': ['gracias'],
      'sorry': ['lo siento', 'perdón'],
      'good morning': ['Buenos días'],
      'good night': ['Buenas noches'],
      'am': ['soy', 'estoy'],
      'is': ['es', 'está'],
      'are': ['son', 'están'],
      'have': ['tener', 'haber'],
      'go': ['ir'],
      'come': ['venir'],
      'eat': ['comer'],
      'drink': ['beber'],
      'run': ['correr'],
      'walk': ['caminar'],
      'read': ['leer'],
      'write': ['escribir'],
      'speak': ['hablar'],
      'listen': ['escuchar'],
      'see': ['ver'],
      'look': ['mirar'],
      'play': ['jugar'],
      'study': ['estudiar'],
      'work': ['trabajar'],
      'sleep': ['dormir'],
      'house': ['casa'],
      'car': ['coche', 'auto'],
      'dog': ['perro'],
      'cat': ['gato'],
      'bird': ['pájaro'],
      'fish': ['pez', 'pescado'],
      'tree': ['árbol'],
      'book': ['libro'],
      'school': ['escuela'],
      'teacher': ['profesor', 'maestro'],
      'student': ['estudiante', 'alumno'],
      'friend': ['amigo'],
      'family': ['familia'],
      'mother': ['madre', 'mamá'],
      'father': ['padre', 'papá'],
      'brother': ['hermano'],
      'sister': ['hermana'],
      'food': ['comida'],
      'water': ['agua'],
      'sun': ['sol'],
      'moon': ['luna'],
      'star': ['estrella'],
      'sky': ['cielo'],
      'day': ['día'],
      'night': ['noche'],
      'good': ['bueno', 'bien'],
      'bad': ['malo', 'mal'],
      'big': ['grande'],
      'small': ['pequeño'],
      'happy': ['feliz'],
      'sad': ['triste'],
      'beautiful': ['hermoso', 'bonito'],
      'ugly': ['feo'],
      'hot': ['caliente'],
      'cold': ['frío'],
      'new': ['nuevo'],
      'old': ['viejo'],
      'fast': ['rápido'],
      'slow': ['lento'],
      'red': ['rojo'],
      'blue': ['azul'],
      'green': ['verde'],
      'yellow': ['amarillo'],
      'black': ['negro'],
      'white': ['blanco'],
      'one': ['uno'],
      'two': ['dos'],
      'three': ['tres'],
      'four': ['cuatro'],
      'five': ['cinco'],
      'monday': ['lunes'],
      'tuesday': ['martes'],
      'wednesday': ['miércoles'],
      'thursday': ['jueves'],
      'friday': ['viernes'],
      'saturday': ['sábado'],
      'sunday': ['domingo'],
      'city': ['ciudad'],
      'park': ['parque'],
      'beach': ['playa'],
      'mountain': ['montaña'],
      'river': ['río'],
      'forest': ['bosque'],
      'lollypop': ['piruleta', 'chupachups'],
      'stay': ['quedarse', 'permanecer'],
      'smile': ['sonrisa', 'sonreír'],
      'sick': ['enfermo', 'mal'],
      'table': ['mesa', 'tabla'],
      'also': ['también', 'además'],
      'computer': ['computadora', 'ordenador']
    };
    const wordTypes = {
      'hello': 'noun', 'hi': 'noun', 'goodbye': 'noun', 'please': 'adverb', 'thank you': 'noun', 'sorry': 'noun',
      'good morning': 'noun', 'good night': 'noun', 'am': 'verb', 'is': 'verb', 'are': 'verb', 'have': 'verb',
      'go': 'verb', 'come': 'verb', 'eat': 'verb', 'drink': 'verb', 'run': 'verb', 'walk': 'verb', 'read': 'verb',
      'write': 'verb', 'speak': 'verb', 'listen': 'verb', 'see': 'verb', 'look': 'verb', 'play': 'verb',
      'study': 'verb', 'work': 'verb', 'sleep': 'verb', 'house': 'noun', 'car': 'noun', 'dog': 'noun',
      'cat': 'noun', 'bird': 'noun', 'fish': 'noun', 'tree': 'noun', 'book': 'noun', 'school': 'noun',
      'teacher': 'noun', 'student': 'noun', 'friend': 'noun', 'family': 'noun', 'mother': 'noun',
      'father': 'noun', 'brother': 'noun', 'sister': 'noun', 'food': 'noun', 'water': 'noun', 'sun': 'noun',
      'moon': 'noun', 'star': 'noun', 'sky': 'noun', 'day': 'noun', 'night': 'noun', 'good': 'adjective',
      'bad': 'adjective', 'big': 'adjective', 'small': 'adjective', 'happy': 'adjective', 'sad': 'adjective',
      'beautiful': 'adjective', 'ugly': 'adjective', 'hot': 'adjective', 'cold': 'adjective', 'new': 'adjective',
      'old': 'adjective', 'fast': 'adjective', 'slow': 'adjective', 'red': 'adjective', 'blue': 'adjective',
      'green': 'adjective', 'yellow': 'adjective', 'black': 'adjective', 'white': 'adjective', 'one': 'noun',
      'two': 'noun', 'three': 'noun', 'four': 'noun', 'five': 'noun', 'monday': 'noun', 'tuesday': 'noun',
      'wednesday': 'noun', 'thursday': 'noun', 'friday': 'noun', 'saturday': 'noun', 'sunday': 'noun',
      'city': 'noun', 'park': 'noun', 'beach': 'noun', 'mountain': 'noun', 'river': 'noun', 'forest': 'noun',
      'lollypop': 'noun', 'stay': 'verb', 'smile': 'verb', 'sick': 'adjective', 'table': 'noun', 'also': 'adverb',
      'computer': 'noun'
    };

    class Particle {
      constructor() {
        this.x = random(width);
        this.y = random(height);
        this.size = random(2, 8);
        this.speed = random(0.5, 2);
        this.alpha = random(50, 150);
      }
      update() {
        this.y -= this.speed;
        if (this.y < -this.size) {
          this.y = height + this.size;
          this.x = random(width);
        }
      }
      display() {
        noStroke();
        fill(255, 255, 255, this.alpha);
        ellipse(this.x, this.y, this.size);
      }
    }

    function normalizeText(text) {
      return text
        .toLowerCase()
        .normalize('NFD')
        .replace(/[\u0300-\u036f]/g, '')
        .replace(/[^a-zA-Z\s]/g, '')
        .trim();
    }

    function random(array) {
      return array[Math.floor(Math.random() * array.length)];
    }

    function shuffleArray(array) {
      for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
      }
      return array;
    }

    async function getTranslations(word) {
      try {
        if (fallbackTranslations[word]) {
          return fallbackTranslations[word].map(normalizeText);
        }
        const response = await fetch(`https://api.mymemory.translated.net/get?q=${encodeURIComponent(word)}&langpair=en|es`);
        if (!response.ok) {
          throw new Error(`HTTP error! Status: ${response.status}`);
        }
        const data = await response.json();
        if (data.responseData && data.responseData.translatedText) {
          const translation = normalizeText(data.responseData.translatedText);
          const combinedTranslations = new Set([
            translation,
            ...(fallbackTranslations[word] ? fallbackTranslations[word].map(normalizeText) : [])
          ]);
          return Array.from(combinedTranslations);
        }
        return null;
      } catch (error) {
        console.error(`Error al consultar MyMemory para "${word}": ${error.message}`);
        return fallbackTranslations[word] ? fallbackTranslations[word].map(normalizeText) : null;
      }
    }

    function setup() {
      createCanvas(600, 400);
      document.getElementById('fileInput').addEventListener('change', handleFile);
      color1 = color(100, 150, 200); // Sky blue
      color2 = color(150, 100, 200); // Purple
      for (let i = 0; i < 50; i++) {
        particles.push(new Particle());
      }
    }

    function drawAnimatedBackground() {
      let t = (sin(frameCount * 0.005) + 1) / 2;
      for (let y = 0; y < height; y++) {
        let c = lerpColor(color1, color2, t * (y / height));
        stroke(c);
        line(0, y, width, y);
      }
      for (let p of particles) {
        p.update();
        p.display();
      }
    }

    function draw() {
      drawAnimatedBackground();
      textAlign(CENTER);
      fill(0); // Black for high contrast

      if (gameState === 'countdown') {
        let elapsed = millis() - countdownTimer;
        let currentNumber = floor(3 - elapsed / 1000);
        if (currentNumber < 1) {
          gameState = 'playing';
          timeLeft = difficultyTimes[document.getElementById('typeSelect').value];
          shuffleArray(phrases);
          currentPhraseIndex = 0;
          selectNewPhrase();
          document.getElementById('inputTranslation').style.display = 'block';
          document.getElementById('submitButton').style.display = 'block';
          return;
        }
        let progress = (elapsed % 1000) / 1000;
        let size = lerp(100, 50, progress);
        textSize(size);
        text(currentNumber, width / 2, height / 2);
      } else if (gameState === 'waiting') {
        textSize(24);
        if (!fileLoaded) {
          text('Upload a file to start...', width / 2, height / 2);
          if (phrases.length === 0 && document.getElementById('fileInput').files.length > 0) {
            text('Processing file...', width / 2, height / 2 + 50);
          }
        } else {
          text('File loaded! Click Start Game.', width / 2, height / 2);
        }
      } else if (gameState === 'playing') {
        textSize(24);
        if (currentPhrase && currentPhrase.english) {
          text('Translate: "' + currentPhrase.english + '"', width / 2, 50);
          text('Score: ' + score, width / 2, 100);
          text('Correct: ' + correctAnswers + ' | Incorrect: ' + incorrectTranslations, width / 2, 130);
          text('Time Left: ' + ceil(timeLeft), width / 2, 160);
          text('Round: ' + (round + 1) + '/' + maxRounds, width / 2, 190);
          timeLeft -= 1 / frameRate();
          if (timeLeft <= 0) {
            incorrectTranslations++;
            errors.push({ word: currentPhrase.english, expected: currentPhrase.spanish.join(' or '), userInput: '' });
            nextRound();
          }
        } else {
          text('Error: No word available', width / 2, height / 2);
          setTimeout(() => {
            gameState = 'finalResults';
          }, 2000);
        }
      } else if (gameState === 'practice') {
        textSize(24);
        if (currentPhrase && currentPhrase.english) {
          text('Corrigiendo Errores: Ronda ' + (practiceRound + 1) + '/' + maxPracticeRounds, width / 2, 50);
          text('Translate: "' + currentPhrase.english + '"', width / 2, 100);
          text('Correct: ' + correctAnswers + ' | Incorrect: ' + incorrectTranslations, width / 2, 130);
          text('Time Left: ' + ceil(timeLeft), width / 2, 160);
          timeLeft -= 1 / frameRate();
          if (timeLeft <= 0) {
            nextPracticeRound();
          }
        } else {
          text('Error: No word available', width / 2, height / 2);
          setTimeout(() => {
            gameState = 'finalResults';
          }, 2000);
        }
      } else if (gameState === 'congratulations') {
        textSize(32);
        text('¡Felicidades! Todas las palabras correctas', width / 2, height / 2 - 60);
        textSize(20);
        text('Score: ' + score, width / 2, height / 2 - 30);
        text('Correct: ' + correctAnswers + ' | Incorrect: ' + incorrectTranslations, width / 2, height / 2);
      } else if (gameState === 'gameOver') {
        textSize(32);
        text('¡Fin del juego! Palabras completadas', width / 2, height / 2 - 60);
        textSize(20);
        text('Score: ' + score, width / 2, height / 2 - 30);
        text('Correct: ' + correctAnswers + ' | Incorrect: ' + incorrectTranslations, width / 2, height / 2);
      } else if (gameState === 'finalResults') {
        document.getElementById('fileInput').style.display = 'block';
        document.getElementById('typeSelect').style.display = 'block';
        document.getElementById('inputTranslation').style.display = 'none';
        document.getElementById('submitButton').style.display = 'none';
        textSize(32);
        text('¡Resultados finales!', width / 2, height / 2 - 90);
        textSize(20);
        text('Final Score: ' + score, width / 2, height / 2 - 60);
        text('Correct: ' + correctAnswers + ' | Incorrect: ' + incorrectTranslations, width / 2, height / 2 - 30);
        text('Upload a new file to play again.', width / 2, height / 2);
        if (errors.length > 0) {
          let table = select('#errorTable');
          if (!table) {
            table = createElement('table');
            table.id('errorTable');
            let header = createElement('tr');
            header.child(createElement('th', 'Word'));
            header.child(createElement('th', 'Expected'));
            header.child(createElement('th', 'Your Input'));
            table.child(header);
            for (let error of errors) {
              let row = createElement('tr');
              row.child(createElement('td', error.word));
              row.child(createElement('td', error.expected));
              row.child(createElement('td', error.userInput));
              table.child(row);
            }
            let downloadButton = createButton('Download Errors as Text');
            downloadButton.position(width / 2 - 80, height / 2 + 100);
            downloadButton.mousePressed(downloadErrors);
          }
        } else {
          text('No errors to review!', width / 2, height / 2 + 30);
        }
      }

      if (gameState === 'waiting' && fileLoaded) {
        document.getElementById('startButton').style.display = 'block';
      } else {
        document.getElementById('startButton').style.display = 'none';
      }
    }

    function downloadErrors() {
      let errorText = 'Translation Errors\n\n';
      if (errors.length > 0) {
        errorText += 'Word Translation Errors:\n';
        errorText += 'Word | Expected | Your Input\n';
        errorText += '-----|---------|-----------\n';
        for (let error of errors) {
          errorText += `${error.word} | ${error.expected} | ${error.userInput}\n`;
        }
      }
      let blob = new Blob([errorText], { type: 'text/plain' });
      let url = URL.createObjectURL(blob);
      let a = createA(url, 'Download Errors');
      a.attribute('download', 'translation_errors.txt');
      a.elt.click();
      URL.revokeObjectURL(url);
    }

    async function handleFile(event) {
      const file = event.target.files[0];
      if (!file) {
        alert('Please select a file.');
        return;
      }
      if (!file.name.endsWith('.txt')) {
        alert('Please upload a .txt file.');
        return;
      }
      const reader = new FileReader();
      reader.onload = async function(e) {
        const words = e.target.result.split(/[\n,]/).map(w => w.trim()).filter(w => w);
        if (words.length === 0) {
          alert('The file is empty or contains no valid words.');
          return;
        }
        phrases = [];
        for (let word of [...new Set(words)]) {
          const lowerWord = word.toLowerCase();
          let wordTranslations = translations[lowerWord];
          if (!wordTranslations) {
            wordTranslations = await getTranslations(lowerWord);
            if (!wordTranslations) {
              if (fallbackTranslations[lowerWord]) {
                wordTranslations = fallbackTranslations[lowerWord].map(normalizeText);
              } else {
                const translationsInput = prompt(`No translations found for "${word}". Please enter Spanish translations separated by commas (e.g., "casa, hogar") or leave blank to skip this word:`, '');
                if (translationsInput) {
                  wordTranslations = translationsInput.split(',').map(t => normalizeText(t)).filter(t => t);
                }
              }
            }
            if (wordTranslations && wordTranslations.length > 0) {
              translations[lowerWord] = wordTranslations;
            }
          }
          if (wordTranslations && wordTranslations.length > 0) {
            phrases.push({
              english: lowerWord,
              spanish: wordTranslations
            });
          }
        }
        if (phrases.length > 0) {
          fileLoaded = true;
        } else {
          alert('No valid words found in the file. Ensure words have available translations or enter translations manually.');
        }
      };
      reader.onerror = () => {
        alert('Error reading the file. Please try again.');
      };
      reader.readAsText(file);
    }

    function startPlaying() {
      if (phrases.length === 0 || !fileLoaded) {
        gameState = 'waiting';
        alert('No valid words to play with. Please upload a file.');
        return;
      }
      gameState = 'countdown';
      countdownNumber = 3;
      countdownTimer = millis();
      document.getElementById('fileInput').style.display = 'none';
      document.getElementById('typeSelect').style.display = 'none';
      document.getElementById('startButton').style.display = 'none';
    }

    function selectNewPhrase() {
      if (phrases.length > 0 && currentPhraseIndex < phrases.length) {
        currentPhrase = phrases[currentPhraseIndex];
        if (!currentPhrase || !currentPhrase.english || !Array.isArray(currentPhrase.spanish)) {
          console.warn('Invalid phrase at index', currentPhraseIndex, currentPhrase);
          currentPhrase = null;
        }
      } else {
        currentPhrase = null;
      }
      if (!currentPhrase && phrases.length > 0) {
        currentPhraseIndex = 0;
        currentPhrase = phrases[currentPhraseIndex];
        if (!currentPhrase || !currentPhrase.english || !Array.isArray(currentPhrase.spanish)) {
          console.warn('Invalid phrase at index 0', currentPhrase);
          currentPhrase = null;
        }
      }
    }

    function submit() {
      if (gameState !== 'playing' && gameState !== 'practice') {
        return;
      }
      if (!currentPhrase || !currentPhrase.english || !Array.isArray(currentPhrase.spanish)) {
        console.error('No valid current word available', currentPhrase);
        incorrectTranslations++;
        errors.push({
          word: 'Unknown',
          expected: 'N/A',
          userInput: document.getElementById('inputTranslation').value || ''
        });
        document.getElementById('inputTranslation').value = '';
        if (gameState === 'playing') {
          nextRound();
        } else {
          nextPracticeRound();
        }
        return;
      }
      const input = normalizeText(document.getElementById('inputTranslation').value);
      const correctAnswersList = currentPhrase.spanish;
      if (gameState === 'playing' && correctAnswersList.includes(input)) {
        score += 10;
        correctAnswers++;
      } else if (gameState === 'playing') {
        incorrectTranslations++;
        errors.push({
          word: currentPhrase.english,
          expected: currentPhrase.spanish.join(' or '),
          userInput: input || ''
        });
      } else if (gameState === 'practice' && correctAnswersList.includes(input)) {
        correctAnswers++;
      } else if (gameState === 'practice') {
        incorrectTranslations++;
      }
      document.getElementById('inputTranslation').value = '';
      if (gameState === 'playing') {
        nextRound();
      } else {
        nextPracticeRound();
      }
    }

    function nextRound() {
      round++;
      currentPhraseIndex++;
      if (round >= maxRounds || currentPhraseIndex >= phrases.length || !currentPhrase) {
        if (errors.length === 0) {
          gameState = 'congratulations';
          document.getElementById('inputTranslation').style.display = 'none';
          document.getElementById('submitButton').style.display = 'none';
          setTimeout(() => {
            gameState = 'finalResults';
          }, 3000);
        } else if (errors.length > 0 && practiceRound < maxPracticeRounds) {
          gameState = 'practice';
          practiceRound = 0;
          currentPhrase = random(errors);
          timeLeft = difficultyTimes[document.getElementById('typeSelect').value];
        } else {
          gameState = 'gameOver';
          document.getElementById('inputTranslation').style.display = 'none';
          document.getElementById('submitButton').style.display = 'none';
          setTimeout(() => {
            gameState = 'finalResults';
          }, 3000);
        }
      } else {
        selectNewPhrase();
        timeLeft = difficultyTimes[document.getElementById('typeSelect').value];
      }
    }

    function nextPracticeRound() {
      practiceRound++;
      if (practiceRound >= maxPracticeRounds || errors.length === 0 || !currentPhrase) {
        gameState = 'gameOver';
        document.getElementById('inputTranslation').style.display = 'none';
        document.getElementById('submitButton').style.display = 'none';
        setTimeout(() => {
          gameState = 'finalResults';
          fileLoaded = false;
        }, 3000);
      } else {
        currentPhrase = random(errors);
        timeLeft = difficultyTimes[document.getElementById('typeSelect').value];
      }
    }

    document.getElementById('inputTranslation').addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        submit();
      }
    });
  </script>
</body>
</html>
