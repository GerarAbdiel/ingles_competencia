<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Translate Blitz Pro</title>
    <link rel="icon" type="image/svg+xml" href="/vite.svg" />
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #fff;
            overflow-x: hidden;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            position: relative;
            z-index: 10;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            padding: 30px 0;
        }

        .title {
            font-size: 3.5rem;
            font-weight: bold;
            background: linear-gradient(45deg, #fff, #e6e6ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 10px;
            text-shadow: 0 0 30px rgba(255, 255, 255, 0.3);
        }

        .subtitle {
            font-size: 1.2rem;
            opacity: 0.9;
            margin-bottom: 30px;
        }

        .api-config {
            background: rgba(255, 255, 255, 0.1);
            -webkit-backdrop-filter: blur(10px);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .api-config h3 {
            margin-bottom: 15px;
            color: #e6e6ff;
        }

        .api-input-group {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        .api-input {
            flex: 1;
            min-width: 300px;
            padding: 12px 15px;
            border: none;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.9);
            color: #333;
            font-size: 14px;
        }

        .api-input::placeholder {
            color: #666;
        }

        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .btn-primary {
            background: linear-gradient(45deg, #4facfe 0%, #00f2fe 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(79, 172, 254, 0.4);
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .btn-danger {
            background: rgba(231, 76, 60, 0.8);
            color: white;
            border: 1px solid rgba(231, 76, 60, 0.5);
        }

        .btn-danger:hover {
            background: rgba(231, 76, 60, 1);
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(231, 76, 60, 0.4);
        }

        /* Vocabulary Selector */
        .vocabulary-selector {
            text-align: center;
            margin-bottom: 25px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .vocabulary-selector h4 {
            margin-bottom: 15px;
            color: #fff;
            font-size: 1.2rem;
        }

        .percentage-buttons {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .percentage-btn {
            padding: 8px 16px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
            min-width: 60px;
        }

        .percentage-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }

        .percentage-btn.active {
            background: rgba(79, 172, 254, 0.8);
            border-color: rgba(79, 172, 254, 1);
            box-shadow: 0 4px 15px rgba(79, 172, 254, 0.3);
        }

        .vocabulary-info {
            color: rgba(255, 255, 255, 0.8);
            font-size: 0.9rem;
            margin: 0;
        }

        /* Game Stats */
        .game-stats {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .stat-item {
            background: rgba(255, 255, 255, 0.1);
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 0.9rem;
        }

        .stat-label {
            font-weight: 500;
            margin-right: 5px;
        }

        /* Results Table */
        .results-table {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            margin-top: 30px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .results-table h3 {
            text-align: center;
            margin-bottom: 25px;
            color: #fff;
            font-size: 1.8rem;
        }

        .results-summary {
            margin-bottom: 30px;
        }

        .summary-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .summary-item {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .summary-label {
            display: block;
            font-weight: 500;
            margin-bottom: 5px;
            color: rgba(255, 255, 255, 0.8);
        }

        .errors-table h4 {
            margin-bottom: 20px;
            color: #fff;
            text-align: center;
        }

        .errors-table-content {
            width: 100%;
            border-collapse: collapse;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            overflow: hidden;
        }

        .errors-table-content th,
        .errors-table-content td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .errors-table-content th {
            background: rgba(255, 255, 255, 0.1);
            font-weight: 600;
            color: #fff;
        }

        .errors-table-content td {
            color: rgba(255, 255, 255, 0.9);
        }

        .errors-table-content tr:last-child td {
            border-bottom: none;
        }

        .no-errors {
            text-align: center;
            padding: 40px;
            color: #2ecc71;
            font-size: 1.2rem;
            font-weight: 500;
        }

        .results-actions {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 30px;
        }

        /* Game Elements Styles */
        .game-area {
            background: rgba(255, 255, 255, 0.1);
            -webkit-backdrop-filter: blur(10px);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            min-height: 400px;
        }

        .difficulty-selector {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }

        .difficulty-btn {
            padding: 12px 20px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            min-width: 120px;
        }

        .difficulty-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }

        .difficulty-btn.active {
            background: rgba(79, 172, 254, 0.8);
            border-color: rgba(79, 172, 254, 1);
            box-shadow: 0 4px 15px rgba(79, 172, 254, 0.3);
        }

        .game-controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .game-display {
            text-align: center;
            min-height: 200px;
        }

        .phase-indicator {
            font-size: 1.1rem;
            margin-bottom: 15px;
            padding: 8px 16px;
            background: rgba(79, 172, 254, 0.3);
            border-radius: 20px;
            display: inline-block;
            font-weight: 500;
        }

        .word-display {
            font-size: 3rem;
            font-weight: bold;
            margin: 30px 0;
            padding: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            min-height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .timer {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 20px;
            color: #ffd700;
            background: rgba(255, 215, 0, 0.2);
            padding: 10px 20px;
            border-radius: 20px;
            display: inline-block;
        }

        .input-area {
            margin: 30px 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
        }

        .translation-input {
            width: 100%;
            max-width: 400px;
            padding: 15px 20px;
            border: none;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.9);
            color: #333;
            font-size: 1.1rem;
            text-align: center;
        }

        .translation-input:focus {
            outline: none;
            box-shadow: 0 0 20px rgba(79, 172, 254, 0.5);
        }

        .voice-controls {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
            justify-content: center;
        }

        .mic-btn {
            background: rgba(231, 76, 60, 0.8);
            color: white;
            border: none;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            font-size: 1.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .mic-btn:hover {
            background: rgba(231, 76, 60, 1);
            transform: scale(1.1);
        }

        .mic-btn.recording {
            background: rgba(255, 0, 0, 0.8);
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        .score-display {
            text-align: center;
            margin-top: 20px;
        }

        .score {
            font-size: 1.3rem;
            font-weight: bold;
            color: #ffd700;
        }

        .feedback {
            margin-top: 30px;
            padding: 20px;
            border-radius: 10px;
            border-left: 4px solid;
            background: rgba(255, 255, 255, 0.1);
            opacity: 0.8;
            font-size: 0.9em;
        }

        .feedback.success {
            border-left-color: #2ecc71;
            background: rgba(46, 204, 113, 0.1);
        }

        .feedback.error {
            border-left-color: #e74c3c;
            background: rgba(231, 76, 60, 0.1);
        }

        .status {
            text-align: center;
            margin: 20px 0;
            font-size: 1.1rem;
        }

        .hidden {
            display: none !important;
        }

        .hidden-file-input {
            display: none;
        }

        .api-description {
            margin-bottom: 15px;
            opacity: 0.8;
        }

        @media (max-width: 768px) {
            .title {
                font-size: 2.5rem;
            }
            
            .container {
                padding: 15px;
            }
            
            .game-area {
                padding: 20px 15px;
            }
            
            .word-display {
                font-size: 2rem;
            }
            
            .api-input-group {
                flex-direction: column;
            }
            
            .api-input {
                min-width: 100%;
                margin-bottom: 10px;
            }
            
            .percentage-buttons {
                gap: 8px;
            }
            
            .percentage-btn {
                padding: 6px 12px;
                font-size: 0.9rem;
                min-width: 50px;
            }
            
            .game-stats {
                gap: 10px;
            }
            
            .stat-item {
                padding: 6px 10px;
                font-size: 0.8rem;
            }
            
            .errors-table-content {
                font-size: 0.9rem;
            }
            
            .errors-table-content th,
            .errors-table-content td {
                padding: 8px;
            }
        }
    </style>
</head>
<body>
    <div id="particles-canvas"></div>
    
    <div class="container">
        <div class="header">
            <h1 class="title">üéØ Translate Blitz Pro</h1>
            <p class="subtitle">Juego educativo de traducci√≥n ingl√©s-espa√±ol con IA avanzada</p>
        </div>

        <!-- API Configuration Section -->
        <div class="api-config" id="apiConfig">
            <h3>üîë Configuraci√≥n de API</h3>
            <p class="api-description">
                Usa la clave predeterminada o ingresa tu propia API key de OpenRouter
            </p>
            <div class="api-input-group">
                <input type="password" 
                       id="apiKeyInput" 
                       class="api-input" 
                       placeholder="Ingresa tu API key de OpenRouter (opcional)">
                <button onclick="updateApiKey()" class="btn btn-primary">Actualizar</button>
                <button onclick="testConnection()" class="btn btn-secondary">Probar Conexi√≥n</button>
            </div>
            <div id="apiStatus" class="status"></div>
        </div>

        <!-- Game Area -->
        <div class="game-area">
            <div class="difficulty-selector" id="difficultySelector">
                <button class="difficulty-btn active" data-difficulty="easy">
                    F√°cil (15s)
                </button>
                <button class="difficulty-btn" data-difficulty="medium">
                    Medio (8s)
                </button>
                <button class="difficulty-btn" data-difficulty="hard">
                    Dif√≠cil (3s)
                </button>
            </div>

            <!-- Vocabulary Percentage Selector -->
            <div class="vocabulary-selector" id="vocabularySelector">
                <h4>üìä Porcentaje de Vocabulario</h4>
                <div class="percentage-buttons">
                    <button class="percentage-btn" data-percentage="10">10%</button>
                    <button class="percentage-btn" data-percentage="25">25%</button>
                    <button class="percentage-btn active" data-percentage="50">50%</button>
                    <button class="percentage-btn" data-percentage="100">100%</button>
                </div>
                <p class="vocabulary-info" id="vocabularyInfo">
                    Palabras a jugar: <span id="wordsToPlay">-</span> de <span id="totalWords">-</span>
                </p>
            </div>

            <div class="game-controls" id="gameControls">
                <button onclick="startGame()" class="btn btn-primary" id="startBtn">
                    üéÆ Iniciar Juego
                </button>
                <button onclick="loadVocabulary()" class="btn btn-secondary">
                    üìö Cargar Vocabulario
                </button>
                <button onclick="resetGame()" class="btn btn-secondary">
                    üîÑ Reiniciar
                </button>
            </div>

            <div class="game-display">
                <div id="phaseIndicator" class="phase-indicator hidden">
                    Fase: Traducci√≥n
                </div>
                
                <div id="wordDisplay" class="word-display hidden">
                    <!-- Word will appear here -->
                </div>
                
                <div id="timer" class="timer hidden">
                    Tiempo: 15s
                </div>
                
                <div class="input-area">
                    <input type="text" 
                           id="translationInput" 
                           class="translation-input hidden" 
                           placeholder="Escribe tu traducci√≥n aqu√≠...">
                    
                    <button onclick="submitTranslation()" 
                            class="btn btn-primary hidden" 
                            id="submitTranslationBtn">
                        Enviar Traducci√≥n
                    </button>
                    
                    <div class="voice-controls hidden" id="voiceControls">
                        <button class="mic-btn" id="micBtn" onclick="toggleRecording()">
                            üé§
                        </button>
                        
                    </div>
                </div>
                
                <div class="score-display">
                    <div class="score" id="scoreDisplay">Puntuaci√≥n: 0</div>
                    <div class="game-stats hidden" id="gameStats">
                        <div class="stat-item">
                            <span class="stat-label">Palabra:</span>
                            <span id="currentWordNumber">1</span> / <span id="totalGameWords">0</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">‚úÖ Correctas:</span>
                            <span id="correctWords">0</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">‚ùå Incorrectas:</span>
                            <span id="incorrectWords">0</span>
                        </div>
                    </div>
                </div>
            </div>

            <div id="feedback" class="feedback hidden">
                <!-- Feedback will appear here -->
            </div>

            <!-- Results Table -->
            <div id="resultsTable" class="results-table hidden">
                <h3>üìä Resumen del Juego</h3>
                <div class="results-summary">
                    <div class="summary-stats">
                        <div class="summary-item">
                            <span class="summary-label">Total de palabras:</span>
                            <span id="summaryTotal">0</span>
                        </div>
                        <div class="summary-item">
                            <span class="summary-label">‚úÖ Correctas:</span>
                            <span id="summaryCorrect">0</span>
                        </div>
                        <div class="summary-item">
                            <span class="summary-label">‚ùå Incorrectas:</span>
                            <span id="summaryIncorrect">0</span>
                        </div>
                        <div class="summary-item">
                            <span class="summary-label">üìà Porcentaje de acierto:</span>
                            <span id="summaryPercentage">0%</span>
                        </div>
                    </div>
                </div>
                
                <div class="errors-table" id="errorsTableContainer">
                    <h4>‚ùå Errores Cometidos</h4>
                    <table class="errors-table-content">
                        <thead>
                            <tr>
                                <th>Palabra</th>
                                <th>Tu Respuesta</th>
                                <th>Respuesta Correcta</th>
                                <th>Tipo de Error</th>
                                <th>Explicaci√≥n</th>
                            </tr>
                        </thead>
                        <tbody id="errorsTableBody">
                            <!-- Los errores se a√±adir√°n aqu√≠ din√°micamente -->
                        </tbody>
                    </table>
                    <div id="noErrorsMessage" class="no-errors hidden">
                        üéâ ¬°Excelente! No cometiste ning√∫n error.
                    </div>
                </div>
                
                <div class="results-actions">
                    <button onclick="startNewGame()" class="btn btn-primary">üîÑ Jugar de Nuevo</button>
                    <button onclick="resetGame()" class="btn btn-secondary">üè† Men√∫ Principal</button>
                </div>
            </div>
        </div>

        <!-- Status Display -->
        <div id="gameStatus" class="status">
            üéØ Listo para jugar. Configura la dificultad y presiona "ÔøΩ Iniciar Juego".
        </div>
    </div>

    <!-- File input for vocabulary (hidden) -->
    <input type="file" id="vocabularyFile" accept=".txt" class="hidden-file-input" onchange="handleVocabularyFile(event)">

    <script>
        // ========================================
        // TRANSLATE BLITZ PRO - COMPLETE STANDALONE VERSION
        // ========================================
        
        console.log('üéÆ Loading Translate Blitz Pro Standalone...');

        // Configuration
        const CONFIG = {
            OPENROUTER_API_KEY: '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',
            OPENROUTER_ENDPOINT: 'https://openrouter.ai/api/v1/chat/completions',
            MODEL: 'meta-llama/llama-3.3-70b-instruct:free',
            DIFFICULTIES: {
                easy: 15000,
                medium: 8000,
                hard: 3000
            },
            MAX_PRONUNCIATION_ATTEMPTS: 3,
            PASSING_SCORE: 60,
            AI_TIMEOUT: 30000,
            SPEECH_CONFIG: {
                echoCancellation: true,
                noiseSuppression: true,
                autoGainControl: true
            }
        };

        // Default vocabulary
        const DEFAULT_VOCABULARY = [
            'house', 'car', 'book', 'water', 'food', 'family', 'friend', 'work', 'school', 'time',
            'day', 'night', 'morning', 'afternoon', 'evening', 'week', 'month', 'year', 'today', 'tomorrow',
            'yesterday', 'love', 'happy', 'sad', 'angry', 'beautiful', 'good', 'bad', 'big', 'small',
            'hot', 'cold', 'new', 'old', 'fast', 'slow', 'easy', 'difficult', 'important', 'interesting'
        ];

        // Game state
        class GameState {
            constructor() {
                this.reset();
            }

            reset() {
                this.vocabulary = [...DEFAULT_VOCABULARY];
                this.currentWord = '';
                this.currentPhase = 'translation'; // 'translation' or 'pronunciation'
                this.score = 0;
                this.level = 1;
                this.wordsCompleted = 0;
                this.totalWordsAttempted = 0;
                this.difficulty = 'easy';
                this.timeLeft = 0;
                this.timer = null;
                this.isPlaying = false;
                this.translationScore = 0;
                this.pronunciationScore = 0;
                this.pronunciationAttempts = 0;
                this.recordedAudio = null;
                this.recognition = null;
                this.isRecording = false;
                this.userTranslation = '';
                this.userPronunciation = '';
                
                // New properties for enhanced game features
                this.vocabularyPercentage = 50; // Default 50%
                this.gameWords = []; // Words selected for this game
                this.currentWordIndex = 0;
                this.correctWords = 0;
                this.incorrectWords = 0;
                this.errors = []; // Array to store error details
                this.gameFinished = false;
            }
        }

        // Main game class
        class TranslateBlitzGame {
            constructor() {
                this.state = new GameState();
                this.apiKey = CONFIG.OPENROUTER_API_KEY;
                this.recordingInProgress = false; // Flag para prevenir bucles
                this.autoStopTimeout = null; // Timeout para auto-detener grabaci√≥n
                this.initializeSpeechRecognition();
                this.initializeMediaRecorder();
                console.log('üéÆ Game initialized with default API key');
            }

            // ========================================
            // API MANAGEMENT
            // ========================================

            updateApiKey(newKey) {
                this.apiKey = newKey;
                console.log('üîë API key updated');
            }

            async testApiConnection() {
                try {
                    const response = await this.makeApiRequest("Test connection", 5000);
                    return response && response.choices && response.choices.length > 0;
                } catch (error) {
                    console.error('‚ùå API connection test failed:', error);
                    return false;
                }
            }

            async makeApiRequest(prompt, timeout = CONFIG.AI_TIMEOUT) {
                const requestBody = {
                    model: CONFIG.MODEL,
                    messages: [
                        {
                            role: "user",
                            content: prompt
                        }
                    ],
                    max_tokens: 300,
                    temperature: 0.3
                };

                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), timeout);

                try {
                    const response = await fetch(CONFIG.OPENROUTER_ENDPOINT, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${this.apiKey}`,
                            'Content-Type': 'application/json',
                            'HTTP-Referer': window.location.origin,
                            'X-Title': 'Translate Blitz Pro'
                        },
                        body: JSON.stringify(requestBody),
                        signal: controller.signal
                    });

                    clearTimeout(timeoutId);

                    if (!response.ok) {
                        if (response.status === 429) {
                            console.warn('‚ö†Ô∏è Rate limit hit, retrying...');
                            await new Promise(resolve => setTimeout(resolve, 2000));
                            return this.makeApiRequest(prompt, timeout);
                        }
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }

                    const data = await response.json();
                    return data;
                } catch (error) {
                    clearTimeout(timeoutId);
                    if (error.name === 'AbortError') {
                        throw new Error('Request timeout');
                    }
                    throw error;
                }
            }

            // ========================================
            // SPEECH RECOGNITION
            // ========================================

            initializeSpeechRecognition() {
                // Inicializar tanto SpeechRecognition como MediaRecorder
                this.initializeSpeechRecognitionAPI();
                this.initializeMediaRecorder();
            }

            initializeSpeechRecognitionAPI() {
                try {
                    const SpeechRecognition = window.SpeechRecognition || 
                                            window.webkitSpeechRecognition || 
                                            window.msSpeechRecognition ||
                                            window.mozSpeechRecognition;
                    
                    this.state.recognition = new SpeechRecognition();
                    
                    // Configuraci√≥n b√°sica
                    this.state.recognition.continuous = false;
                    this.state.recognition.interimResults = false;
                    this.state.recognition.lang = 'en-US';
                    
                    // Event handlers
                    this.state.recognition.onstart = () => {
                        console.log('üé§ Speech recognition started successfully');
                        this.state.isRecording = true;
                        this.recordingInProgress = false;
                        updateMicButton(true);
                        updateGameStatus('üé§ Grabando con reconocimiento de voz... Habla claramente (se detendr√° autom√°ticamente en 5 segundos)');
                        
                        // Auto-detener despu√©s de 5 segundos
                        this.autoStopTimeout = setTimeout(() => {
                            if (this.state.isRecording && this.state.recognition) {
                                console.log('‚è∞ Auto-deteniendo SpeechRecognition despu√©s de 5 segundos');
                                try {
                                    this.state.recognition.stop();
                                } catch (e) {
                                    console.log('Error stopping recognition:', e);
                                }
                            }
                        }, 5000);
                    };
                    
                    this.state.recognition.onresult = (event) => {
                        const transcript = event.results[0][0].transcript.toLowerCase().trim();
                        this.state.userPronunciation = transcript;
                        console.log('üé§ Speech recognized:', transcript);
                        updateGameStatus(`‚úÖ Pronunciaci√≥n detectada: "${transcript}"`, 'success');
                    };
                    
                    this.state.recognition.onerror = (event) => {
                        console.error('‚ùå Speech recognition error:', event.error);
                        
                        // Limpiar timeout autom√°tico
                        if (this.autoStopTimeout) {
                            clearTimeout(this.autoStopTimeout);
                            this.autoStopTimeout = null;
                        }
                        
                        this.state.isRecording = false;
                        this.recordingInProgress = false;
                        updateMicButton(false);
                        
                        if (event.error === 'not-allowed') {
                            updateGameStatus('‚ùå Permisos denegados. Permite el acceso al micr√≥fono.', 'error');
                        } else {
                            updateGameStatus('‚ùå Error en reconocimiento. Intenta grabaci√≥n manual.', 'error');
                        }
                    };
                    
                    this.state.recognition.onend = () => {
                        console.log('üé§ Speech recognition ended');
                        
                        // Limpiar timeout autom√°tico
                        if (this.autoStopTimeout) {
                            clearTimeout(this.autoStopTimeout);
                            this.autoStopTimeout = null;
                        }
                        
                        this.state.isRecording = false;
                        this.recordingInProgress = false;
                        updateMicButton(false);
                        
                        if (this.state.userPronunciation) {
                            updateGameStatus(`‚úÖ Reconocimiento completado: "${this.state.userPronunciation}"`, 'success');
                            
                            // Autom√°ticamente evaluar la pronunciaci√≥n
                            setTimeout(() => {
                                this.submitPronunciation();
                            }, 800);
                        } else {
                            updateGameStatus('‚ö†Ô∏è No se detect√≥ pronunciaci√≥n. Intenta grabaci√≥n manual.', 'error');
                        }
                    };
                    
                } catch (error) {
                    console.log('SpeechRecognition no disponible, usando solo MediaRecorder');
                    this.state.recognition = null;
                }
            }

            initializeMediaRecorder() {
                // Inicializar variables para MediaRecorder
                this.mediaRecorder = null;
                this.audioChunks = [];
                this.recordingStream = null;
            }

            // ========================================
            // MEDIA RECORDER FUNCTIONS
            // ========================================

            async startMediaRecording() {
                try {
                    // Solicitar permisos de micr√≥fono
                    this.recordingStream = await navigator.mediaDevices.getUserMedia({ 
                        audio: {
                            echoCancellation: true,
                            noiseSuppression: true,
                            autoGainControl: true
                        }
                    });

                    // Crear MediaRecorder
                    this.mediaRecorder = new MediaRecorder(this.recordingStream);
                    this.audioChunks = [];

                    // Event handlers para MediaRecorder
                    this.mediaRecorder.ondataavailable = (event) => {
                        if (event.data.size > 0) {
                            this.audioChunks.push(event.data);
                        }
                    };

                    this.mediaRecorder.onstop = () => {
                        const audioBlob = new Blob(this.audioChunks, { type: 'audio/webm' });
                        console.log('üé§ Audio grabado correctamente:', audioBlob.size, 'bytes');
                        
                        // Simular transcripci√≥n (en una implementaci√≥n real, enviar√≠as esto a un servicio)
                        this.simulateTranscription(audioBlob);
                        
                        // Limpiar stream
                        this.cleanupRecording();
                    };

                    this.mediaRecorder.onerror = (event) => {
                        console.error('‚ùå MediaRecorder error:', event.error);
                        updateGameStatus('‚ùå Error al grabar audio', 'error');
                        this.cleanupRecording();
                    };

                    // Iniciar grabaci√≥n
                    this.mediaRecorder.start();
                    this.state.isRecording = true;
                    updateMicButton(true);
                    updateGameStatus('üé§ Grabando audio... Habla la palabra claramente (se detendr√° autom√°ticamente en 5 segundos)');
                    
                    // Auto-detener despu√©s de 5 segundos
                    this.autoStopTimeout = setTimeout(() => {
                        if (this.state.isRecording && this.mediaRecorder && this.mediaRecorder.state === 'recording') {
                            console.log('‚è∞ Auto-deteniendo grabaci√≥n despu√©s de 5 segundos');
                            this.stopMediaRecording();
                        }
                    }, 5000);
                    
                    return true;
                } catch (error) {
                    console.error('‚ùå Error starting MediaRecorder:', error);
                    updateGameStatus('‚ùå No se puede acceder al micr√≥fono', 'error');
                    this.recordingInProgress = false;
                    return false;
                }
            }

            stopMediaRecording() {
                // Limpiar timeout autom√°tico
                if (this.autoStopTimeout) {
                    clearTimeout(this.autoStopTimeout);
                    this.autoStopTimeout = null;
                }
                
                if (this.mediaRecorder && this.mediaRecorder.state === 'recording') {
                    this.mediaRecorder.stop();
                    this.state.isRecording = false;
                    updateMicButton(false);
                    updateGameStatus('üîÑ Procesando grabaci√≥n...', '');
                }
            }

            cleanupRecording() {
                // Limpiar timeout autom√°tico
                if (this.autoStopTimeout) {
                    clearTimeout(this.autoStopTimeout);
                    this.autoStopTimeout = null;
                }
                
                // Limpiar stream de audio
                if (this.recordingStream) {
                    this.recordingStream.getTracks().forEach(track => track.stop());
                    this.recordingStream = null;
                }
                
                // Limpiar MediaRecorder
                this.mediaRecorder = null;
                this.audioChunks = [];
                
                // Limpiar estados
                this.state.isRecording = false;
                this.recordingInProgress = false;
                updateMicButton(false);
            }

            simulateTranscription(audioBlob) {
                // En una implementaci√≥n real, enviar√≠as el audioBlob a un servicio de transcripci√≥n
                // Por ahora, simularemos una transcripci√≥n basada en la palabra actual
                
                updateGameStatus('üîÑ Analizando pronunciaci√≥n...', '');
                
                setTimeout(() => {
                    // Simulaci√≥n: comparar con la palabra actual
                    const targetWord = this.state.currentWord.toLowerCase();
                    
                    // Simular que a veces funciona bien
                    const similarity = Math.random();
                    
                    if (similarity > 0.3) {
                        // Simular transcripci√≥n exitosa
                        this.state.userPronunciation = targetWord;
                        updateGameStatus(`‚úÖ Audio grabado y analizado: "${targetWord}"`, 'success');
                    } else {
                        // Simular transcripci√≥n con error
                        this.state.userPronunciation = targetWord + '_variant';
                        updateGameStatus(`‚ö†Ô∏è Audio grabado. Pronunciaci√≥n detectada: "${this.state.userPronunciation}"`, 'success');
                    }
                    
                    // Autom√°ticamente evaluar la pronunciaci√≥n
                    setTimeout(() => {
                        this.submitPronunciation();
                    }, 800);
                }, 1500);
            }

            toggleRecording() {
                // Prevenir clics m√∫ltiples r√°pidos
                if (this.recordingInProgress) {
                    return;
                }

                if (this.state.isRecording) {
                    // Detener grabaci√≥n (ambos m√©todos)
                    try {
                        // Limpiar timeout autom√°tico
                        if (this.autoStopTimeout) {
                            clearTimeout(this.autoStopTimeout);
                            this.autoStopTimeout = null;
                        }
                        
                        if (this.state.recognition) {
                            this.state.recognition.stop();
                        }
                        this.stopMediaRecording();
                    } catch (e) {
                        console.log('Error stopping recording:', e);
                    }
                    this.cleanupRecording();
                    updateGameStatus('üî¥ Grabaci√≥n detenida', '');
                    return;
                }

                // Iniciar grabaci√≥n
                this.recordingInProgress = true;
                this.stopWordAudio();
                this.state.userPronunciation = '';
                
                updateGameStatus('üé§ Preparando grabaci√≥n...', '');
                
                // Intentar primero SpeechRecognition, si falla usar MediaRecorder
                setTimeout(async () => {
                    let speechRecognitionStarted = false;
                    
                    // Intentar SpeechRecognition primero
                    if (this.state.recognition) {
                        try {
                            this.state.recognition.start();
                            speechRecognitionStarted = true;
                            console.log('‚úÖ SpeechRecognition iniciado');
                        } catch (error) {
                            console.log('‚ùå SpeechRecognition fall√≥:', error);
                        }
                    }
                    
                    // Si SpeechRecognition no funcion√≥, usar MediaRecorder como fallback
                    if (!speechRecognitionStarted) {
                        console.log('üîÑ Usando MediaRecorder como alternativa');
                        const mediaStarted = await this.startMediaRecording();
                        if (!mediaStarted) {
                            updateGameStatus('‚ùå No se pudo iniciar grabaci√≥n. Intenta de nuevo.', 'error');
                            this.recordingInProgress = false;
                        } else {
                            // Limpiar flag solo si la grabaci√≥n inici√≥ exitosamente
                            this.recordingInProgress = false;
                        }
                    } else {
                        // Limpiar flag si SpeechRecognition inici√≥ exitosamente
                        this.recordingInProgress = false;
                    }
                }, 100);
            }

            // ========================================
            // AUDIO PRONUNCIATION
            // ========================================

            playWordAudio(word, speed = 1.0) {
                try {
                    // Use Web Speech API for text-to-speech
                    if ('speechSynthesis' in window) {
                        // Stop any current speech
                        speechSynthesis.cancel();
                        
                        const utterance = new SpeechSynthesisUtterance(word);
                        utterance.lang = 'en-US';
                        utterance.rate = speed; // 1.0 = normal, 0.5 = slow
                        utterance.pitch = 1.0;
                        utterance.volume = 1.0;
                        
                        // Try to use a native English voice
                        const voices = speechSynthesis.getVoices();
                        const englishVoice = voices.find(voice => 
                            voice.lang.startsWith('en-') && 
                            (voice.name.includes('Microsoft') || voice.name.includes('Google') || voice.name.includes('Alex'))
                        ) || voices.find(voice => voice.lang.startsWith('en-'));
                        
                        if (englishVoice) {
                            utterance.voice = englishVoice;
                        }
                        
                        utterance.onstart = () => {
                            console.log(`üîä Playing audio for "${word}" at ${speed}x speed`);
                        };
                        
                        utterance.onerror = (event) => {
                            console.error('‚ùå Speech synthesis error:', event.error);
                            updateGameStatus('Error al reproducir audio', 'error');
                        };
                        
                        speechSynthesis.speak(utterance);
                        
                        const speedText = speed === 1.0 ? 'normal' : 'lenta';
                        updateGameStatus(`üîä Reproduciendo pronunciaci√≥n ${speedText} de "${word}"`, 'success');
                    } else {
                        updateGameStatus('‚ùå S√≠ntesis de voz no disponible en este navegador', 'error');
                    }
                } catch (error) {
                    console.error('‚ùå Error playing audio:', error);
                    updateGameStatus('Error al reproducir audio', 'error');
                }
            }

            stopWordAudio() {
                if ('speechSynthesis' in window) {
                    speechSynthesis.cancel();
                }
            }

            // ========================================
            // GAME LOGIC
            // ========================================

            setDifficulty(difficulty) {
                this.state.difficulty = difficulty;
                console.log(`üéØ Difficulty set to: ${difficulty}`);
            }

            loadVocabulary(content) {
                try {
                    const words = content.split('\n')
                        .map(line => line.trim())
                        .filter(line => line.length > 0 && !line.startsWith('#'));
                    
                    if (words.length > 0) {
                        this.state.vocabulary = words;
                        console.log(`üìö Loaded ${words.length} words`);
                    }
                } catch (error) {
                    console.error('‚ùå Error loading vocabulary:', error);
                    updateGameStatus('Error al cargar vocabulario', 'error');
                }
            }

            // ========================================
            // VOCABULARY MANAGEMENT
            // ========================================

            setVocabularyPercentage(percentage) {
                this.state.vocabularyPercentage = percentage;
                this.updateVocabularyInfo();
            }

            updateVocabularyInfo() {
                const totalWords = this.state.vocabulary.length;
                const wordsToPlay = Math.ceil(totalWords * this.state.vocabularyPercentage / 100);
                
                document.getElementById('totalWords').textContent = totalWords;
                document.getElementById('wordsToPlay').textContent = wordsToPlay;
            }

            selectGameWords() {
                const totalWords = this.state.vocabulary.length;
                const wordsToPlay = Math.ceil(totalWords * this.state.vocabularyPercentage / 100);
                
                // Shuffle vocabulary and select the required number of words
                const shuffled = [...this.state.vocabulary].sort(() => Math.random() - 0.5);
                this.state.gameWords = shuffled.slice(0, wordsToPlay);
                this.state.currentWordIndex = 0;
                
                console.log(`üéØ Selected ${this.state.gameWords.length} words for this game (${this.state.vocabularyPercentage}%)`);
            }

            getCurrentWord() {
                if (this.state.currentWordIndex >= this.state.gameWords.length) {
                    return null; // Game finished
                }
                return this.state.gameWords[this.state.currentWordIndex];
            }

            moveToNextWord() {
                this.state.currentWordIndex++;
                if (this.state.currentWordIndex >= this.state.gameWords.length) {
                    this.finishGame();
                    return false;
                }
                return true;
            }

            getRandomWord() {
                // Legacy method - now uses the new system
                return this.getCurrentWord();
            }

            // ========================================
            // GAME FLOW
            // ========================================

            startNewGame() {
                this.resetGame();
                this.state.isPlaying = true;
                
                // Select words for this game based on percentage
                this.selectGameWords();
                
                // Ocultar elementos innecesarios durante el juego
                this.hideGameSetupElements();
                
                // Show game stats
                this.showGameStats();
                
                this.startNewRound();
                updateGameStatus('üéÆ ¬°Juego iniciado! Traduce la palabra al espa√±ol', 'success');
            }

            hideGameSetupElements() {
                // Ocultar configuraci√≥n de API
                const apiConfig = document.getElementById('apiConfig');
                if (apiConfig) apiConfig.classList.add('hidden');
                
                // Ocultar selector de dificultad
                const difficultySelector = document.getElementById('difficultySelector');
                if (difficultySelector) difficultySelector.classList.add('hidden');
                
                // Ocultar selector de vocabulario
                const vocabularySelector = document.getElementById('vocabularySelector');
                if (vocabularySelector) vocabularySelector.classList.add('hidden');
                
                // Ocultar botones de control del juego
                const gameControls = document.getElementById('gameControls');
                if (gameControls) gameControls.classList.add('hidden');
            }

            showGameSetupElements() {
                // Mostrar configuraci√≥n de API
                const apiConfig = document.getElementById('apiConfig');
                if (apiConfig) apiConfig.classList.remove('hidden');
                
                // Mostrar selector de dificultad
                const difficultySelector = document.getElementById('difficultySelector');
                if (difficultySelector) difficultySelector.classList.remove('hidden');
                
                // Mostrar selector de vocabulario
                const vocabularySelector = document.getElementById('vocabularySelector');
                if (vocabularySelector) vocabularySelector.classList.remove('hidden');
                
                // Mostrar botones de control del juego
                const gameControls = document.getElementById('gameControls');
                if (gameControls) gameControls.classList.remove('hidden');
            }

            startNewRound() {
                if (!this.state.isPlaying) return;

                // Check if we have more words to play
                const currentWord = this.getCurrentWord();
                if (!currentWord) {
                    this.finishGame();
                    return;
                }

                this.state.currentWord = currentWord;
                this.state.currentPhase = 'translation';
                this.state.translationScore = 0;
                this.state.pronunciationScore = 0;
                this.state.pronunciationAttempts = 0;
                this.state.userTranslation = '';
                this.state.userPronunciation = '';

                // Update word counter
                this.updateGameStats();

                // Update UI
                updateWordDisplay(this.state.currentWord);
                updatePhase('Traducci√≥n');
                showTranslationInput();
                hideVoiceControls();
                
                // Clear input and enable controls
                const input = document.getElementById('translationInput');
                const submitBtn = document.getElementById('submitTranslationBtn');
                
                if (input) {
                    input.value = '';
                    input.disabled = false; // Asegurar que est√© habilitado
                    input.focus();
                }
                
                if (submitBtn) {
                    submitBtn.disabled = false; // Asegurar que est√© habilitado
                    submitBtn.textContent = 'Enviar Traducci√≥n'; // Restaurar texto original
                }

                // Start timer
                this.startTimer();

                console.log(`üéØ New round: ${this.state.currentWord}`);
            }

            startTimer() {
                this.state.timeLeft = CONFIG.DIFFICULTIES[this.state.difficulty];
                this.updateTimerDisplay();

                this.state.timer = setInterval(() => {
                    this.state.timeLeft -= 100;
                    this.updateTimerDisplay();

                    if (this.state.timeLeft <= 0) {
                        this.handleTimeout();
                    }
                }, 100);
            }

            updateTimerDisplay() {
                const seconds = Math.max(0, Math.ceil(this.state.timeLeft / 1000));
                updateTimer(seconds);
            }

            stopTimer() {
                if (this.state.timer) {
                    clearInterval(this.state.timer);
                    this.state.timer = null;
                }
            }

            handleTimeout() {
                this.stopTimer();
                
                if (this.state.currentPhase === 'translation') {
                    showFeedback('‚è∞ ¬°Tiempo agotado! No completaste la traducci√≥n a tiempo.', 'error');
                } else {
                    showFeedback('‚è∞ ¬°Tiempo agotado! No completaste la pronunciaci√≥n a tiempo.', 'error');
                }

                setTimeout(() => {
                    this.endRound(false);
                }, 2000);
            }

            async submitTranslation() {
                const input = document.getElementById('translationInput');
                const submitBtn = document.getElementById('submitTranslationBtn');
                
                if (!input || !input.value.trim()) {
                    updateGameStatus('‚ö†Ô∏è Ingresa una traducci√≥n', 'error');
                    return;
                }

                // Deshabilitar input y bot√≥n inmediatamente para evitar env√≠os m√∫ltiples
                input.disabled = true;
                if (submitBtn) {
                    submitBtn.disabled = true;
                    submitBtn.textContent = 'Procesando...';
                }

                this.state.userTranslation = input.value.trim();
                this.stopTimer();

                // Show loading
                showFeedback('ü§ñ Validando traducci√≥n con IA...', '');
                updateGameStatus('Validando traducci√≥n...', '');

                try {
                    const result = await this.validateTranslation(this.state.currentWord, this.state.userTranslation);
                    this.state.translationScore = result.score;

                    // Create detailed feedback message
                    let feedbackMessage = `<h4>üìù Evaluaci√≥n de tu traducci√≥n:</h4>`;
                    feedbackMessage += `<p><strong>Puntuaci√≥n:</strong> ${result.score}/100</p>`;
                    feedbackMessage += `<p><strong>Tu respuesta:</strong> "${this.state.userTranslation}"</p>`;
                    
                    if (result.correctTranslations && result.correctTranslations.length > 0) {
                        feedbackMessage += `<p><strong>Traducciones correctas:</strong> ${result.correctTranslations.join(', ')}</p>`;
                    }
                    
                    feedbackMessage += `<p><strong>Explicaci√≥n:</strong> ${result.explanation}</p>`;

                    if (result.score >= CONFIG.PASSING_SCORE) {
                        feedbackMessage += `<p style="color: #2ecc71; font-weight: bold;">‚úÖ ¬°Traducci√≥n aprobada! Continuando a pronunciaci√≥n...</p>`;
                        showFeedback(feedbackMessage, 'success');
                        
                        // Wait 10 seconds for user to read, then continue
                        setTimeout(() => {
                            this.startPronunciationPhase();
                        }, 10000);
                    } else {
                        feedbackMessage += `<p style="color: #e74c3c; font-weight: bold;">‚ùå Traducci√≥n no aprobada. Continuando con nueva palabra...</p>`;
                        showFeedback(feedbackMessage, 'error');
                        
                        // Add error to tracking with detailed info
                        const correctTranslations = result.correctTranslations && result.correctTranslations.length > 0 
                            ? result.correctTranslations.join(', ') 
                            : 'Varias traducciones v√°lidas';
                        
                        this.addError(
                            this.state.currentWord,
                            this.state.userTranslation,
                            correctTranslations,
                            'translation',
                            result.explanation
                        );
                        
                        // Wait 10 seconds for user to read, then continue
                        setTimeout(() => {
                            this.endRound(false);
                        }, 10000);
                    }
                } catch (error) {
                    console.error('‚ùå Translation validation error:', error);
                    showFeedback('‚ùå Error al validar la traducci√≥n. Intenta de nuevo.', 'error');
                    
                    // Reactivar controles en caso de error
                    const input = document.getElementById('translationInput');
                    const submitBtn = document.getElementById('submitTranslationBtn');
                    
                    if (input) input.disabled = false;
                    if (submitBtn) {
                        submitBtn.disabled = false;
                        submitBtn.textContent = 'Enviar Traducci√≥n';
                    }
                    
                    this.startTimer(); // Restart timer
                }
            }

            async validateTranslation(englishWord, spanishTranslation) {
                const prompt = `Eval√∫a la traducci√≥n del ingl√©s al espa√±ol:

Palabra en ingl√©s: "${englishWord}"
Traducci√≥n propuesta: "${spanishTranslation}"

Eval√∫a esta traducci√≥n considerando:
1. Correcci√≥n sem√°ntica (significado exacto)
2. Variaciones regionales del espa√±ol
3. Sin√≥nimos aceptables
4. Contexto apropiado

Proporciona:
- Una puntuaci√≥n del 0 al 100
- Una explicaci√≥n detallada en espa√±ol
- Traducciones alternativas correctas

Formato de respuesta:
PUNTUACION: [n√∫mero]
EXPLICACION: [explicaci√≥n detallada]
ALTERNATIVAS: [lista de traducciones correctas separadas por comas]

Ejemplos de puntuaciones:
- 100: Traducci√≥n perfecta
- 80-99: Muy buena, sin√≥nimo apropiado  
- 60-79: Aceptable, pero no ideal
- 40-59: Parcialmente correcta
- 0-39: Incorrecta`;

                try {
                    const response = await this.makeApiRequest(prompt);
                    
                    if (response && response.choices && response.choices[0]) {
                        const content = response.choices[0].message.content.trim();
                        console.log('AI Response:', content);
                        
                        // Parse the response
                        const scoreMatch = content.match(/PUNTUACION:\s*(\d+)/i);
                        const explanationMatch = content.match(/EXPLICACION:\s*(.*?)(?=ALTERNATIVAS:|$)/is);
                        const alternativesMatch = content.match(/ALTERNATIVAS:\s*(.*)/is);
                        
                        const score = scoreMatch ? parseInt(scoreMatch[1]) : 0;
                        const explanation = explanationMatch ? explanationMatch[1].trim() : 
                            `Tu traducci√≥n "${spanishTranslation}" para "${englishWord}" ha sido evaluada. ${score >= 60 ? 'Es una traducci√≥n aceptable.' : 'Necesita mejorarse.'}`;
                        const correctTranslations = alternativesMatch ? 
                            alternativesMatch[1].split(',').map(t => t.trim()).filter(t => t.length > 0) : [];
                        
                        return {
                            score: Math.min(Math.max(score, 0), 100),
                            explanation: explanation,
                            correctTranslations: correctTranslations
                        };
                    }
                    
                    return {
                        score: 0,
                        explanation: `No se pudo evaluar la traducci√≥n "${spanishTranslation}" para "${englishWord}". Intenta con una traducci√≥n m√°s clara.`,
                        correctTranslations: []
                    };
                } catch (error) {
                    console.error('‚ùå AI validation error:', error);
                    throw error;
                }
            }

            startPronunciationPhase() {
                this.state.currentPhase = 'pronunciation';
                updatePhase('Pronunciaci√≥n');
                hideTranslationInput();
                showVoiceControls();

                let message = `üó£Ô∏è Ahora pronuncia la palabra "<strong>${this.state.currentWord}</strong>" en ingl√©s.<br>`;
                message += `<small>El sistema intentar√° reconocimiento de voz autom√°tico o grabaci√≥n de audio seg√∫n tu navegador.</small>`;
                
                showFeedback(message, '');
                
                // Auto-play the word pronunciation at normal speed
                setTimeout(() => {
                    this.playWordAudio(this.state.currentWord, 1.0);
                }, 1000);
                
                // Start new timer for pronunciation phase
                this.startTimer();
            }

            async submitPronunciation() {
                if (!this.state.userPronunciation) {
                    updateGameStatus('‚ö†Ô∏è Primero graba tu pronunciaci√≥n', 'error');
                    return;
                }

                this.stopTimer();
                showFeedback('ü§ñ Analizando pronunciaci√≥n...', '');

                try {
                    const score = await this.validatePronunciation(this.state.currentWord, this.state.userPronunciation);
                    this.state.pronunciationScore = score;

                    if (score >= CONFIG.PASSING_SCORE) {
                        showFeedback(`‚úÖ ¬°Excelente pronunciaci√≥n! Puntuaci√≥n: ${score}/100`, 'success');
                        this.endRound(true);
                    } else {
                        this.state.pronunciationAttempts++;
                        
                        if (this.state.pronunciationAttempts < CONFIG.MAX_PRONUNCIATION_ATTEMPTS) {
                            showFeedback(`‚ö†Ô∏è Pronunciaci√≥n mejorable (${score}/100). Intentos restantes: ${CONFIG.MAX_PRONUNCIATION_ATTEMPTS - this.state.pronunciationAttempts}`, 'error');
                            this.state.userPronunciation = '';
                            this.startTimer();
                        } else {
                            showFeedback(`‚ùå Pronunciaci√≥n no lograda despu√©s de ${CONFIG.MAX_PRONUNCIATION_ATTEMPTS} intentos. Puntuaci√≥n: ${score}/100`, 'error');
                            
                            // Add error to tracking
                            this.addError(
                                this.state.currentWord,
                                this.state.userPronunciation,
                                this.state.currentWord,
                                'pronunciation',
                                `Pronunciaci√≥n no aceptable (${score}/100). Se requiere al menos ${CONFIG.PASSING_SCORE}/100.`
                            );
                            
                            this.endRound(false);
                        }
                    }
                } catch (error) {
                    console.error('‚ùå Pronunciation validation error:', error);
                    showFeedback('‚ùå Error al validar la pronunciaci√≥n. Intenta de nuevo.', 'error');
                    this.startTimer();
                }
            }

            async validatePronunciation(targetWord, spokenWord) {
                const prompt = `Eval√∫a la pronunciaci√≥n en ingl√©s:

Palabra objetivo: "${targetWord}"
Palabra pronunciada (reconocida): "${spokenWord}"

Eval√∫a considerando:
1. Similitud fon√©tica
2. Reconocimiento de la palabra correcta
3. Claridad de pronunciaci√≥n
4. Posibles variaciones de acento

Responde SOLO con un n√∫mero del 0 al 100 que represente la calidad de la pronunciaci√≥n.
Ejemplos:
- 100: Pronunciaci√≥n perfecta
- 80-99: Muy buena pronunciaci√≥n
- 60-79: Aceptable, se entiende
- 40-59: Necesita mejora
- 0-39: Pronunciaci√≥n muy pobre o palabra incorrecta

Respuesta (solo el n√∫mero):`;

                try {
                    const response = await this.makeApiRequest(prompt);
                    
                    if (response && response.choices && response.choices[0]) {
                        const content = response.choices[0].message.content.trim();
                        const score = parseInt(content.match(/\d+/)?.[0] || '0');
                        return Math.min(Math.max(score, 0), 100);
                    }
                    
                    return 0;
                } catch (error) {
                    console.error('‚ùå AI pronunciation validation error:', error);
                    throw error;
                }
            }

            // ========================================
            // GAME STATISTICS AND UI UPDATES
            // ========================================

            showGameStats() {
                const gameStats = document.getElementById('gameStats');
                const totalGameWords = document.getElementById('totalGameWords');
                
                if (gameStats) gameStats.classList.remove('hidden');
                if (totalGameWords) totalGameWords.textContent = this.state.gameWords.length;
                
                this.updateGameStats();
            }

            hideGameStats() {
                const gameStats = document.getElementById('gameStats');
                if (gameStats) gameStats.classList.add('hidden');
            }

            updateGameStats() {
                document.getElementById('currentWordNumber').textContent = this.state.currentWordIndex + 1;
                document.getElementById('totalGameWords').textContent = this.state.gameWords.length;
                document.getElementById('correctWords').textContent = this.state.correctWords;
                document.getElementById('incorrectWords').textContent = this.state.incorrectWords;
            }

            addError(word, userAnswer, correctAnswer, errorType, explanation) {
                this.state.errors.push({
                    word: word,
                    userAnswer: userAnswer,
                    correctAnswer: correctAnswer,
                    errorType: errorType, // 'translation' or 'pronunciation'
                    explanation: explanation
                });
            }

            finishGame() {
                this.state.isPlaying = false;
                this.state.gameFinished = true;
                
                this.hideGameStats();
                this.showGameSetupElements();
                this.showResultsTable();
                
                updateGameStatus('üéâ ¬°Juego completado! Revisa tus resultados abajo.', 'success');
                console.log('üèÅ Game finished!');
            }

            showResultsTable() {
                const resultsTable = document.getElementById('resultsTable');
                const errorsTableBody = document.getElementById('errorsTableBody');
                const noErrorsMessage = document.getElementById('noErrorsMessage');
                const errorsTableContainer = document.getElementById('errorsTableContainer');
                
                // Show results table
                if (resultsTable) resultsTable.classList.remove('hidden');
                
                // Update summary stats
                const totalWords = this.state.gameWords.length;
                const correctWords = this.state.correctWords;
                const incorrectWords = this.state.incorrectWords;
                const percentage = totalWords > 0 ? Math.round((correctWords / totalWords) * 100) : 0;
                
                document.getElementById('summaryTotal').textContent = totalWords;
                document.getElementById('summaryCorrect').textContent = correctWords;
                document.getElementById('summaryIncorrect').textContent = incorrectWords;
                document.getElementById('summaryPercentage').textContent = percentage + '%';
                
                // Clear and populate errors table
                if (errorsTableBody) {
                    errorsTableBody.innerHTML = '';
                    
                    if (this.state.errors.length === 0) {
                        if (noErrorsMessage) noErrorsMessage.classList.remove('hidden');
                        if (errorsTableContainer) {
                            const table = errorsTableContainer.querySelector('.errors-table-content');
                            if (table) table.style.display = 'none';
                        }
                    } else {
                        if (noErrorsMessage) noErrorsMessage.classList.add('hidden');
                        if (errorsTableContainer) {
                            const table = errorsTableContainer.querySelector('.errors-table-content');
                            if (table) table.style.display = 'table';
                        }
                        
                        this.state.errors.forEach(error => {
                            const row = document.createElement('tr');
                            row.innerHTML = `
                                <td><strong>${error.word}</strong></td>
                                <td>${error.userAnswer}</td>
                                <td>${error.correctAnswer}</td>
                                <td>${error.errorType === 'translation' ? 'üìù Traducci√≥n' : 'üé§ Pronunciaci√≥n'}</td>
                                <td>${error.explanation}</td>
                            `;
                            errorsTableBody.appendChild(row);
                        });
                    }
                }
            }

            hideResultsTable() {
                const resultsTable = document.getElementById('resultsTable');
                if (resultsTable) resultsTable.classList.add('hidden');
            }

            // ========================================
            // ROUND MANAGEMENT
            // ========================================

            endRound(success) {
                this.stopTimer();
                
                if (success) {
                    this.state.correctWords++;
                    this.state.score += 10; // Add points for correct answer
                    updateScore(this.state.score);
                } else {
                    this.state.incorrectWords++;
                    // Errors are now tracked specifically in submitTranslation and submitPronunciation
                }
                
                // Update game stats
                this.updateGameStats();
                
                // Move to next word or finish game
                setTimeout(() => {
                    if (this.moveToNextWord()) {
                        this.startNewRound();
                    } else {
                        this.finishGame();
                    }
                }, 3000); // Wait 3 seconds before next word
            }

            resetGame() {
                this.stopTimer();
                this.stopWordAudio(); // Stop any playing audio
                this.cleanupRecording(); // Limpiar cualquier grabaci√≥n en curso
                this.state.reset();
                
                // Mostrar elementos de configuraci√≥n
                this.showGameSetupElements();
                
                // Ocultar estad√≠sticas del juego y tabla de resultados
                this.hideGameStats();
                this.hideResultsTable();
                
                // Reset UI
                hideElement('wordDisplay');
                hideElement('timer');
                hideElement('phaseIndicator');
                hideTranslationInput();
                hideVoiceControls();
                showFeedback('', '');
                updateScore(0);
                
                // Reset vocabulary info
                this.updateVocabularyInfo();
                
                console.log('üîÑ Game reset');
            }
        }

        // ========================================
        // PARTICLE SYSTEM (Simple CSS-based)
        // ========================================
        
        function createParticles() {
            const container = document.createElement('div');
            container.id = 'particles-container';
            container.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                pointer-events: none;
                z-index: -1;
                overflow: hidden;
            `;
            
            for (let i = 0; i < 50; i++) {
                const particle = document.createElement('div');
                particle.style.cssText = `
                    position: absolute;
                    width: ${Math.random() * 4 + 2}px;
                    height: ${Math.random() * 4 + 2}px;
                    background: rgba(255, 255, 255, ${Math.random() * 0.6 + 0.2});
                    border-radius: 50%;
                    left: ${Math.random() * 100}%;
                    top: ${Math.random() * 100}%;
                    animation: float ${Math.random() * 10 + 10}s infinite linear;
                `;
                container.appendChild(particle);
            }
            
            // Add CSS animation
            const style = document.createElement('style');
            style.textContent = `
                @keyframes float {
                    0% {
                        transform: translateY(100vh) rotate(0deg);
                        opacity: 0;
                    }
                    10% {
                        opacity: 1;
                    }
                    90% {
                        opacity: 1;
                    }
                    100% {
                        transform: translateY(-100vh) rotate(360deg);
                        opacity: 0;
                    }
                }
            `;
            document.head.appendChild(style);
            document.body.appendChild(container);
        }

        // ========================================
        // EVENT HANDLERS AND UI FUNCTIONS
        // ========================================

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', () => {
            console.log('üéÆ Translate Blitz Pro HTML loaded');
            
            // Create particle background
            createParticles();
            
            // Initialize speech synthesis voices (important for Edge/Chrome)
            if ('speechSynthesis' in window) {
                // Load voices - this is asynchronous in some browsers
                speechSynthesis.getVoices();
                speechSynthesis.onvoiceschanged = () => {
                    console.log('üîä Speech synthesis voices loaded');
                };
            }
            
            // Initialize game instance
            window.gameInstance = new TranslateBlitzGame();
            
            // Initialize difficulty selector
            document.querySelectorAll('.difficulty-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    document.querySelectorAll('.difficulty-btn').forEach(b => b.classList.remove('active'));
                    e.target.classList.add('active');
                    if (window.gameInstance) {
                        window.gameInstance.setDifficulty(e.target.dataset.difficulty);
                    }
                });
            });

            // Initialize vocabulary percentage selector
            document.querySelectorAll('.percentage-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    document.querySelectorAll('.percentage-btn').forEach(b => b.classList.remove('active'));
                    e.target.classList.add('active');
                    if (window.gameInstance) {
                        const percentage = parseInt(e.target.dataset.percentage);
                        window.gameInstance.setVocabularyPercentage(percentage);
                    }
                });
            });

            // Initialize vocabulary info
            if (window.gameInstance) {
                window.gameInstance.updateVocabularyInfo();
            }
            
            console.log('‚úÖ Game fully initialized and ready to play!');
        });

        // API Key Management
        function updateApiKey() {
            const input = document.getElementById('apiKeyInput');
            const key = input.value.trim();
            
            if (key) {
                if (window.gameInstance) {
                    window.gameInstance.updateApiKey(key);
                    updateStatus('apiStatus', '‚úÖ API key actualizada', 'success');
                    input.value = '';
                } else {
                    updateStatus('apiStatus', '‚ö†Ô∏è Juego no inicializado', 'error');
                }
            } else {
                updateStatus('apiStatus', '‚ö†Ô∏è Ingresa una API key v√°lida', 'error');
            }
        }

        async function testConnection() {
            updateStatus('apiStatus', 'üîÑ Probando conexi√≥n...', '');
            
            try {
                if (window.gameInstance) {
                    const success = await window.gameInstance.testApiConnection();
                    if (success) {
                        updateStatus('apiStatus', '‚úÖ Conexi√≥n exitosa con OpenRouter', 'success');
                    } else {
                        updateStatus('apiStatus', '‚ùå Error de conexi√≥n. Verifica tu API key', 'error');
                    }
                } else {
                    updateStatus('apiStatus', '‚ùå Juego no inicializado', 'error');
                }
            } catch (error) {
                updateStatus('apiStatus', '‚ùå Error: ' + error.message, 'error');
            }
        }

        // Game Controls
        function startGame() {
            if (window.gameInstance) {
                window.gameInstance.startNewGame();
            } else {
                updateStatus('gameStatus', '‚ùå Error al iniciar el juego', 'error');
            }
        }

        function resetGame() {
            if (window.gameInstance) {
                window.gameInstance.resetGame();
                updateStatus('gameStatus', 'üîÑ Juego reiniciado', '');
            }
        }

        function loadVocabulary() {
            document.getElementById('vocabularyFile').click();
        }

        function handleVocabularyFile(event) {
            const file = event.target.files[0];
            if (file && window.gameInstance) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const content = e.target.result;
                    window.gameInstance.loadVocabulary(content);
                    updateStatus('gameStatus', 'üìö Vocabulario cargado: ' + file.name, 'success');
                };
                reader.readAsText(file);
            }
        }

        // Voice Controls
        function toggleRecording() {
            if (window.gameInstance) {
                window.gameInstance.toggleRecording();
            }
        }

        function submitPronunciation() {
            if (window.gameInstance) {
                window.gameInstance.submitPronunciation();
            }
        }

        function skipPronunciation() {
            if (window.gameInstance) {
                // Assign a default score for skipped pronunciation
                window.gameInstance.state.pronunciationScore = 50; // Give partial credit
                showFeedback('‚è≠Ô∏è Pronunciaci√≥n omitida. Puntuaci√≥n por defecto: 50/100', '');
                setTimeout(() => {
                    window.gameInstance.endRound(true);
                }, 2000);
            }
        }

        function playAudio(word, speed) {
            if (window.gameInstance) {
                window.gameInstance.playWordAudio(word, speed);
            }
        }

        // Translation submission (called when Enter is pressed or button clicked)
        function submitTranslation() {
            if (window.gameInstance && window.gameInstance.state.currentPhase === 'translation') {
                window.gameInstance.submitTranslation();
            }
        }

        // Utility Functions
        function updateStatus(elementId, message, type = '') {
            const element = document.getElementById(elementId);
            if (element) {
                element.textContent = message;
                element.className = 'status';
                if (type) element.classList.add(type);
            }
        }

        function showElement(elementId) {
            const element = document.getElementById(elementId);
            if (element) element.classList.remove('hidden');
        }

        function hideElement(elementId) {
            const element = document.getElementById(elementId);
            if (element) element.classList.add('hidden');
        }

        // Global functions that the game instance can call
        window.updateWordDisplay = (word) => {
            const element = document.getElementById('wordDisplay');
            if (element) {
                element.innerHTML = `
                    <span>${word}</span>
                    <div class="audio-controls">
                        <button class="audio-btn" onclick="playAudio('${word}', 1.0)" title="Pronunciaci√≥n normal">
                            üîä
                        </button>
                        <button class="audio-btn slow" onclick="playAudio('${word}', 0.6)" title="Pronunciaci√≥n lenta">
                            üêå
                        </button>
                    </div>
                `;
                showElement('wordDisplay');
            }
        };

        window.updateTimer = (time) => {
            const element = document.getElementById('timer');
            if (element) {
                element.textContent = `Tiempo: ${time}s`;
                showElement('timer');
            }
        };

        window.updateScore = (score) => {
            const element = document.getElementById('scoreDisplay');
            if (element) {
                element.textContent = `Puntuaci√≥n: ${score}`;
            }
        };

        window.updatePhase = (phase) => {
            const element = document.getElementById('phaseIndicator');
            if (element) {
                element.textContent = `Fase: ${phase}`;
                showElement('phaseIndicator');
            }
        };

        window.showFeedback = (message, type = '') => {
            const element = document.getElementById('feedback');
            if (element) {
                element.innerHTML = message;
                element.className = 'feedback';
                if (type) element.classList.add(type);
                element.classList.remove('hidden');
            }
        };

        window.updateGameStatus = (message, type = '') => {
            updateStatus('gameStatus', message, type);
        };

        window.showTranslationInput = () => {
            const input = document.getElementById('translationInput');
            const submitBtn = document.getElementById('submitTranslationBtn');
            
            showElement('translationInput');
            showElement('submitTranslationBtn');
            
            // Asegurar que est√©n habilitados al mostrarlos
            if (input) {
                input.disabled = false;
                input.focus();
            }
            if (submitBtn) {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Enviar Traducci√≥n';
            }
        };

        window.hideTranslationInput = () => {
            hideElement('translationInput');
            hideElement('submitTranslationBtn');
        };

        window.showVoiceControls = () => {
            showElement('voiceControls');
        };

        window.hideVoiceControls = () => {
            hideElement('voiceControls');
        };

        window.updateMicButton = (isRecording) => {
            const btn = document.getElementById('micBtn');
            
            if (btn) {
                btn.textContent = isRecording ? 'üî¥' : 'üé§';
                if (isRecording) {
                    btn.classList.add('recording');
                } else {
                    btn.classList.remove('recording');
                }
            }
        };

        // Initialize UI - hide game elements by default
        function initializeUI() {
            // Hide all game elements that should be hidden initially
            hideElement('wordDisplay');
            hideElement('timer'); 
            hideElement('phaseIndicator');
            hideElement('translationInput');
            hideElement('submitTranslationBtn');
            hideElement('voiceControls');
            hideElement('gameStats');
            hideElement('resultsTable');
            hideElement('feedback');
            
            console.log('üé® UI initialized - game elements hidden');
        }

        // Call initialization when page loads
        initializeUI();
    </script>
</body>
</html>
